---
########################################################################
#                                                                      #
# migration                                                            #
#                                                                      #
########################################################################

mash_playbook_service_identifier_prefix: matrix-
mash_playbook_generic_secret_key: "{{ matrix_homeserver_generic_secret_key }}"
mash_playbook_base_path: "{{ matrix_base_data_path }}"
mash_playbook_service_base_directory_name_prefix: ''
mash_playbook_uid: "{{ matrix_user_uid }}"
mash_playbook_gid: "{{ matrix_user_gid }}"
mash_playbook_traefik_labels_enabled: "{{ matrix_playbook_traefik_labels_enabled }}"
mash_playbook_reverse_proxyable_services_additional_network: "{{ matrix_playbook_reverse_proxyable_services_additional_network }}"

# just copied from disabled roles
matrix_dendrite_max_file_size_bytes: 1073741824
matrix_conduit_max_request_size: 20_000_000

########################################################################
#                                                                      #
# languagetool                                                         #
#                                                                      #
########################################################################

languagetool_enabled: false

languagetool_identifier: custom-languagetool

# Base path and data path are the same. This is an old bug. We're keeping compatibility for it.
languagetool_base_path: "{{ matrix_base_data_path }}/custom-languagetool"
languagetool_data_path: "{{ matrix_base_data_path }}/custom-languagetool"

languagetool_uid: "{{ matrix_user_uid }}"
languagetool_gid: "{{ matrix_user_gid }}"

languagetool_hostname: "{{ matrix_server_fqn_languagetool }}"

languagetool_container_network: "{{ matrix_nginx_proxy_container_network if matrix_playbook_reverse_proxy_type != 'playbook-managed-traefik' else languagetool_identifier }}"

languagetool_container_additional_networks: "{{ [matrix_playbook_reverse_proxyable_services_additional_network] if matrix_playbook_reverse_proxyable_services_additional_network else [] }}"

languagetool_container_labels_traefik_enabled: "{{ matrix_playbook_traefik_labels_enabled }}"
languagetool_container_labels_traefik_docker_network: "{{ matrix_playbook_reverse_proxyable_services_additional_network }}"
languagetool_container_labels_traefik_entrypoints: "{{ devture_traefik_entrypoint_primary }}"

########################################################################
#                                                                      #
# miniflux                                                             #
#                                                                      #
########################################################################

miniflux_enabled: false

miniflux_identifier: custom-miniflux

miniflux_base_path: "{{ matrix_base_data_path }}/custom-miniflux"

miniflux_uid: "{{ matrix_user_uid }}"
miniflux_gid: "{{ matrix_user_gid }}"

miniflux_container_network: "{{ matrix_nginx_proxy_container_network if matrix_playbook_reverse_proxy_type != 'playbook-managed-traefik' else miniflux_identifier }}"

miniflux_container_additional_networks: |
  {{
    ([matrix_playbook_reverse_proxyable_services_additional_network] if matrix_playbook_reverse_proxyable_services_additional_network else [])
    +
    ([devture_postgres_container_network] if devture_postgres_enabled and miniflux_database_hostname == devture_postgres_identifier and devture_postgres_container_network != miniflux_container_network else [])
  }}

miniflux_container_labels_traefik_enabled: "{{ matrix_playbook_reverse_proxy_type in ['playbook-managed-traefik', 'other-traefik-container'] }}"
miniflux_container_labels_traefik_docker_network: "{{ matrix_playbook_reverse_proxyable_services_additional_network }}"
miniflux_container_labels_traefik_entrypoints: "{{ devture_traefik_entrypoint_primary }}"
miniflux_container_labels_traefik_tls_certResolver: "{{ devture_traefik_certResolver_primary }}"

miniflux_database_hostname: "{{ devture_postgres_connection_hostname if devture_postgres_enabled else '' }}"
miniflux_database_password: "{{ '%s' | format(matrix_homeserver_generic_secret_key) | password_hash('sha512', 'miniflux.db', rounds=655555) | to_uuid }}"

########################################################################
#                                                                      #
# radicale                                                             #
#                                                                      #
########################################################################

radicale_enabled: false

radicale_identifier: custom-radicale

radicale_container_image: "{{ radicale_container_image_registry_prefix }}etke.cc/radicale:{{ radicale_container_image_tag }}"
radicale_container_image_registry_prefix: registry.etke.cc/

radicale_base_path: "{{ matrix_base_data_path }}/custom-radicale"
radicale_config_path: "{{ radicale_base_path }}/conf"

radicale_auth_type: radicale_auth_matrix
radicale_auth_matrix_server: "{{ matrix_homeserver_container_url }}"

radicale_uid: "{{ matrix_user_uid }}"
radicale_gid: "{{ matrix_user_gid }}"

radicale_container_network: "{{ matrix_nginx_proxy_container_network if matrix_playbook_reverse_proxy_type != 'playbook-managed-traefik' else radicale_identifier }}"

radicale_container_additional_networks: |
  {{
    ([matrix_playbook_reverse_proxyable_services_additional_network] if matrix_playbook_reverse_proxyable_services_additional_network else [])
  }}

radicale_container_labels_traefik_enabled: "{{ matrix_playbook_reverse_proxy_type in ['playbook-managed-traefik', 'other-traefik-container'] }}"
radicale_container_labels_traefik_docker_network: "{{ matrix_playbook_reverse_proxyable_services_additional_network }}"
radicale_container_labels_traefik_entrypoints: "{{ devture_traefik_entrypoint_primary }}"
radicale_container_labels_traefik_tls_certResolver: "{{ devture_traefik_certResolver_primary }}"

########################################################################
#                                                                      #
# uptime-kuma                                                          #
#                                                                      #
########################################################################

uptime_kuma_enabled: false

uptime_kuma_identifier: custom-kuma

uptime_kuma_base_path: "{{ matrix_base_data_path }}/custom-kuma"

uptime_kuma_uid: "{{ matrix_user_uid }}"
uptime_kuma_gid: "{{ matrix_user_gid }}"

uptime_kuma_container_network: "{{ matrix_nginx_proxy_container_network if matrix_playbook_reverse_proxy_type != 'playbook-managed-traefik' else uptime_kuma_identifier }}"

uptime_kuma_container_additional_networks: |
  {{
    ([matrix_playbook_reverse_proxyable_services_additional_network] if matrix_playbook_reverse_proxyable_services_additional_network else [])
  }}

uptime_kuma_container_labels_traefik_enabled: "{{ matrix_playbook_reverse_proxy_type in ['playbook-managed-traefik', 'other-traefik-container'] }}"
uptime_kuma_container_labels_traefik_docker_network: "{{ matrix_playbook_reverse_proxyable_services_additional_network }}"
uptime_kuma_container_labels_traefik_entrypoints: "{{ devture_traefik_entrypoint_primary }}"
uptime_kuma_container_labels_traefik_tls_certResolver: "{{ devture_traefik_certResolver_primary }}"

########################################################################
#                                                                      #
# soft-serve                                                           #
#                                                                      #
########################################################################

soft_serve_enabled: false

soft_serve_identifier: custom-softserve

soft_serve_base_path: "{{ matrix_base_data_path }}/softserve"

soft_serve_uid: "{{ matrix_user_uid }}"
soft_serve_gid: "{{ matrix_user_gid }}"

########################################################################
#                                                                      #
# gotosocial                                                           #
#                                                                      #
########################################################################

gotosocial_enabled: false
gotosocial_identifier: "{{ mash_playbook_service_identifier_prefix }}gotosocial"
gotosocial_base_path: "{{ mash_playbook_base_path }}/{{ mash_playbook_service_base_directory_name_prefix }}gotosocial"

gotosocial_uid: "{{ mash_playbook_uid }}"
gotosocial_gid: "{{ mash_playbook_gid }}"

gotosocial_database_host: "{{ devture_postgres_identifier if devture_postgres_enabled else '' }}"
gotosocial_database_port: "{{ '5432' if devture_postgres_enabled else '' }}"
gotosocial_database_password: "{{ '%s' | format(mash_playbook_generic_secret_key) | password_hash('sha512', 'db.gotosocial', rounds=655555) | to_uuid }}"
gotosocial_database_username: "{{ gotosocial_identifier }}"

gotosocial_systemd_required_services_list: |
  {{
    (['docker.service'])
    +
    ([devture_postgres_identifier ~ '.service'] if devture_postgres_enabled and gotosocial_database_host == devture_postgres_identifier else [])
  }}

gotosocial_container_additional_networks: |
  {{
    ([mash_playbook_reverse_proxyable_services_additional_network] if mash_playbook_reverse_proxyable_services_additional_network else [])
    +
    ([devture_postgres_container_network] if devture_postgres_enabled and gotosocial_database_host == devture_postgres_identifier and gotosocial_container_network != devture_postgres_container_network else [])
  }}

gotosocial_container_labels_traefik_enabled: "{{ mash_playbook_traefik_labels_enabled }}"
gotosocial_container_labels_traefik_docker_network: "{{ mash_playbook_reverse_proxyable_services_additional_network }}"
gotosocial_container_labels_traefik_entrypoints: "{{ devture_traefik_entrypoint_primary }}"
gotosocial_container_labels_traefik_tls_certResolver: "{{ devture_traefik_certResolver_primary }}"

########################################################################
#                                                                      #
# matrix/synapse-auto-compressor                                       #
#                                                                      #
########################################################################

# enabled by default for etke.cc on purpose
matrix_synapse_auto_compressor_enabled: "{{ matrix_synapse_enabled | bool }}"

# The cleanup role will delete our custom network, because it's unused unless the timer gets triggered.
# As a workaround, we just reuse some other network.
# Some servers don't use a playbook-managed Postgres, so we can't use `devture_postgres_container_network` everywhere.
# The Synapse network is available everywhere where Synapse is enabled though.
matrix_synapse_auto_compressor_container_network: "{{ matrix_synapse_container_network }}"

########################################################################
#                                                                      #
# nginx-migration                                                      #
#                                                                      #
########################################################################

nginx_migration_languagetool_enabled: "{{ languagetool_enabled and matrix_playbook_reverse_proxy_type == 'playbook-managed-nginx' }}"
nginx_migration_languagetool_hostname: "{{ languagetool_hostname }}"

nginx_migration_miniflux_enabled: "{{ miniflux_enabled and matrix_playbook_reverse_proxy_type == 'playbook-managed-nginx' }}"
nginx_migration_miniflux_hostname: "{{ miniflux_hostname }}"

nginx_migration_radicale_enabled: "{{ radicale_enabled and matrix_playbook_reverse_proxy_type == 'playbook-managed-nginx' }}"
nginx_migration_radicale_hostname: "{{ radicale_hostname }}"

nginx_migration_uptime_kuma_enabled: "{{ uptime_kuma_enabled and matrix_playbook_reverse_proxy_type == 'playbook-managed-nginx' }}"
nginx_migration_uptime_kuma_hostname: "{{ uptime_kuma_hostname }}"

nginx_migration_honoroit_enabled: "{{ matrix_bot_honoroit_enabled }}"
matrix_bot_honoroit_basicauth_enabled: true
matrix_bot_honoroit_basicauth_user: "{{ matrix_nginx_proxy_proxy_matrix_metrics_basic_auth_username }}"
matrix_bot_honoroit_basicauth_password: "{{ matrix_nginx_proxy_proxy_matrix_metrics_basic_auth_password }}"

nginx_migration_buscarron_enabled: "{{ matrix_bot_buscarron_enabled }}"
matrix_bot_buscarron_basicauth_enabled: true
matrix_bot_buscarron_basicauth_user: "{{ matrix_nginx_proxy_proxy_matrix_metrics_basic_auth_username }}"
matrix_bot_buscarron_basicauth_password: "{{ matrix_nginx_proxy_proxy_matrix_metrics_basic_auth_password }}"

########################################################################
#                                                                      #
# com.devture.ansible.role.systemd_service_manager                     #
#                                                                      #
########################################################################

# Restarting services one by one leads to less downtime
devture_systemd_service_manager_service_restart_mode: one-by-one

# We don't verify that services managed to start to decrease playbook runtime.
# Prometheus will notify us about service failure.
devture_systemd_service_manager_up_verification_enabled: false

devture_systemd_service_manager_services_list_additional: |
  {{
    ([{'name': 'custom-dnsmasq.service', 'priority': 5000, 'groups': ['etke', 'dnsmasq']}] if custom_dnsmasq_enabled else [])
    +
    ([{'name': (gotosocial_identifier + '.service'), 'priority': 5000, 'groups': ['etke', 'gotosocial']}] if gotosocial_enabled else [])
    +
    ([{'name': (uptime_kuma_identifier + '.service'), 'priority': 5000, 'groups': ['etke', 'uptime-kuma']}] if uptime_kuma_enabled else [])
    +
    ([{'name': (languagetool_identifier + '.service'), 'priority': 5000, 'groups': ['etke', 'languagetool']}] if languagetool_enabled else [])
    +
    ([{'name': (miniflux_identifier + '.service'), 'priority': 5000, 'groups': ['etke', 'miniflux']}] if miniflux_enabled else [])
    +
    ([{'name': (radicale_identifier + '.service'), 'priority': 5000, 'groups': ['etke', 'radicale']}] if radicale_enabled else [])
    +
    ([{'name': soft_serve_identifier + '.service', 'priority': 5000, 'groups': ['etke', 'softserve', 'soft-serve']}] if soft_serve_enabled else [])
    +
    ([{'name': ('wg-quick@' + custom_wireguard_interface + '.service'), 'priority': 5000, 'groups': ['etke', 'wireguard']}] if custom_wireguard_enabled else [])
  }}

########################################################################
#                                                                      #
# /com.devture.ansible.role.systemd_service_manager                    #
#                                                                      #
########################################################################


########################################################################
#                                                                      #
# com.devture.ansible.role.postgres                                    #
#                                                                      #
########################################################################

devture_postgres_managed_databases_additional: |
  {{
    ([{
      'name': miniflux_database_name,
      'username': miniflux_database_username,
      'password': miniflux_database_password,
    }] if miniflux_enabled else [])
    +
    ([{
      'name': gotosocial_database_name,
      'username': gotosocial_database_username,
      'password': gotosocial_database_password,
    }] if gotosocial_enabled else [])
  }}

########################################################################
#                                                                      #
# /com.devture.ansible.role.postgres                                   #
#                                                                      #
########################################################################
