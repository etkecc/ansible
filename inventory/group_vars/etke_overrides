---

########################################################################
#                                                                      #
# registry overrides                                                   #
#                                                                      #
########################################################################

matrix_registry_prefix: registry.etke.cc/
custom_dnsmasq_docker_image: "{{ matrix_registry_prefix }}etke.cc/dnsmasq:{{ custom_dnsmasq_version }}"
matrix_client_element_docker_image: "{{ matrix_registry_prefix }}etke.cc/app:{{ matrix_client_element_version }}"
matrix_etherpad_docker_image: "{{ matrix_registry_prefix }}etke.cc/etherpad:{{ matrix_etherpad_version }}"

backup_borg_docker_image_name_prefix: "{{ 'localhost/' if backup_borg_container_image_self_build else matrix_registry_prefix }}"
docker_postgres_container_image_registry_prefix: "{{ matrix_registry_prefix }}"
grafana_container_image_registry_prefix: "{{ matrix_registry_prefix }}"
int_scheduler_docker_image_name_prefix: "{{ matrix_registry_prefix }}"
matrix_appservice_discord_docker_image_name_prefix: "{{ 'localhost/' if matrix_appservice_discord_container_image_self_build else matrix_registry_prefix }}"
matrix_beeper_linkedin_docker_image_name_prefix: "{{ 'localhost/' if matrix_beeper_linkedin_container_image_self_build else matrix_registry_prefix }}"
matrix_bot_buscarron_docker_image_name_prefix: "{{ 'localhost/' if matrix_bot_buscarron_container_image_self_build else matrix_registry_prefix }}"
matrix_bot_chatgpt_docker_image_name_prefix: "{{ 'localhost/' if matrix_bot_chatgpt_container_image_self_build else matrix_registry_prefix }}"
matrix_bot_honoroit_docker_image_name_prefix: "{{ 'localhost/' if matrix_bot_honoroit_container_image_self_build else matrix_registry_prefix }}"
matrix_bot_maubot_docker_image_name_prefix: "{{ 'localhost/' if matrix_bot_maubot_container_image_self_build else matrix_registry_prefix }}"
matrix_bot_postmoogle_docker_image_name_prefix: "{{ 'localhost/' if matrix_bot_postmoogle_container_image_self_build else matrix_registry_prefix }}"
matrix_client_hydrogen_docker_image_name_prefix: "{{ 'localhost/' if matrix_client_hydrogen_container_image_self_build else matrix_registry_prefix }}"
matrix_conduit_docker_image_name_prefix: "{{ matrix_registry_prefix }}"
matrix_container_global_registry_prefix: "{{ matrix_registry_prefix }}"
matrix_dendrite_docker_image_name_prefix: "{{ matrix_registry_prefix }}"
matrix_mautrix_discord_docker_image_name_prefix: "{{ 'localhost/' if matrix_mautrix_discord_container_image_self_build else matrix_registry_prefix }}"
matrix_mautrix_facebook_docker_image_name_prefix: "{{ 'localhost/' if matrix_mautrix_facebook_container_image_self_build else matrix_registry_prefix }}"
matrix_mautrix_googlechat_docker_image_name_prefix: "{{ 'localhost/' if matrix_mautrix_googlechat_container_image_self_build else matrix_registry_prefix }}"
matrix_mautrix_hangouts_docker_image_name_prefix: "{{ 'localhost/' if matrix_mautrix_hangouts_container_image_self_build else matrix_registry_prefix }}"
matrix_mautrix_instagram_docker_image_name_prefix: "{{ 'localhost/' if matrix_mautrix_instagram_container_image_self_build else matrix_registry_prefix }}"
matrix_mautrix_signal_daemon_docker_image_name_prefix: "{{ matrix_registry_prefix }}"
matrix_mautrix_slack_docker_image_name_prefix: "{{ 'localhost/' if matrix_mautrix_slack_container_image_self_build else matrix_registry_prefix }}"
matrix_mautrix_telegram_docker_image_name_prefix: "{{ 'localhost/' if matrix_mautrix_telegram_container_image_self_build else matrix_registry_prefix }}"
matrix_mautrix_twitter_docker_image_name_prefix: "{{ 'localhost/' if matrix_mautrix_twitter_container_image_self_build else matrix_registry_prefix }}"
matrix_mautrix_whatsapp_docker_image_name_prefix: "{{ 'localhost/' if matrix_mautrix_whatsapp_container_image_self_build else matrix_registry_prefix }}"
matrix_mx_puppet_discord_docker_image_name_prefix: "{{ 'localhost/' if matrix_mx_puppet_discord_container_image_self_build else matrix_registry_prefix }}"
matrix_mx_puppet_groupme_docker_image_name_prefix: "{{ 'localhost/' if matrix_mx_puppet_groupme_container_image_self_build else matrix_registry_prefix }}"
matrix_mx_puppet_slack_docker_image_name_prefix: "{{ 'localhost/' if matrix_mx_puppet_slack_container_image_self_build else matrix_registry_prefix }}"
matrix_prometheus_nginxlog_exporter_docker_image_name_prefix: "{{ matrix_registry_prefix }}martin-helmich/"
matrix_s3_goofys_docker_image_name_prefix: "{{ matrix_registry_prefix }}"
matrix_synapse_rust_synapse_compress_state_docker_image_name_prefix: "{{ matrix_registry_prefix }}"
matrix_telegram_lottieconverter_docker_image_name_prefix: "{{ 'localhost/' if matrix_telegram_lottieconverter_container_image_self_build else matrix_registry_prefix }}"
ntfy_container_image_registry_prefix: "{{ matrix_registry_prefix }}"
prometheus_node_exporter_docker_image_name_prefix: "{{ matrix_registry_prefix }}"
prometheus_postgres_exporter_docker_image_name_prefix: "{{ matrix_registry_prefix }}"
redis_container_image_registry_prefix: "{{ matrix_registry_prefix }}"

########################################################################
#                                                                      #
# customization                                                        #
#                                                                      #
########################################################################

# etherpad libreoffice
matrix_etherpad_soffice: /usr/bin/soffice

# element branding
matrix_client_element_branding_authFooterLinks:
  - text: Managed by etke.cc
    url: https://etke.cc

########################################################################
#                                                                      #
# migration from disabled roles                                        #
#                                                                      #
########################################################################

# just copied from disabled roles
matrix_dendrite_max_file_size_bytes: 1073741824
matrix_conduit_max_request_size: 20_000_000

########################################################################
#                                                                      #
# monitoring                                                           #
#                                                                      #
########################################################################

matrix_nginx_proxy_proxy_matrix_metrics_enabled: yes
matrix_prometheus_services_proxy_connect_prometheus_node_exporter_metrics_proxying_enabled: yes
matrix_nginx_proxy_proxy_matrix_metrics_basic_auth_enabled: yes
matrix_nginx_proxy_proxy_matrix_metrics_basic_auth_username: "{{ '%s' | format(matrix_homeserver_generic_secret_key) | password_hash('sha512', 'metrics.username', rounds=655555) | to_uuid }}"
matrix_nginx_proxy_proxy_matrix_metrics_basic_auth_password: "{{ '%s' | format(matrix_homeserver_generic_secret_key) | password_hash('sha512', 'metrics.password', rounds=655555) | to_uuid }}"
prometheus_node_exporter_enabled: yes
prometheus_node_exporter_process_extra_arguments:
  - "--collector.disable-defaults"
  - "--collector.cpu"
  - "--collector.filesystem"
  - "--collector.meminfo"
  - "--collector.systemd"
  - "--collector.uname"
prometheus_node_exporter_container_extra_arguments:
  - "--security-opt apparmor=unconfined"
  - "--mount type=bind,src=/var/run/dbus/system_bus_socket,dst=/var/run/dbus/system_bus_socket,ro,bind-propagation=rslave"

########################################################################
#                                                                      #
# com.devture.ansible.role.systemd_service_manager                     #
#                                                                      #
########################################################################

# Restarting services one by one leads to less downtime
devture_systemd_service_manager_service_restart_mode: one-by-one

# We don't verify that services managed to start to decrease playbook runtime.
# Prometheus will notify us about service failure.
devture_systemd_service_manager_up_verification_enabled: false

devture_systemd_service_manager_services_list_additional: |
  {{
    ([{'name': 'custom-dnsmasq.service', 'priority': 5000, 'groups': ['etke', 'dnsmasq']}] if custom_dnsmasq_enabled else [])
    +
    ([{'name': 'custom-kuma.service', 'priority': 5000, 'groups': ['etke', 'kuma']}] if custom_kuma_enabled else [])
    +
    ([{'name': 'custom-languagetool.service', 'priority': 5000, 'groups': ['etke', 'languagetool']}] if custom_languagetool_enabled else [])
    +
    ([{'name': 'custom-miniflux.service', 'priority': 5000, 'groups': ['etke', 'miniflux']}] if custom_miniflux_enabled else [])
    +
    ([{'name': 'custom-radicale.service', 'priority': 5000, 'groups': ['etke', 'radicale']}] if custom_radicale_enabled else [])
    +
    ([{'name': 'custom-softserve.service', 'priority': 5000, 'groups': ['etke', 'softserve']}] if custom_softserve_enabled else [])
    +
    ([{'name': ('wg-quick@' + custom_wireguard_interface + '.service'), 'priority': 5000, 'groups': ['etke', 'wireguard']}] if custom_wireguard_enabled else [])
    +
    ([{'name': 'int-prometheus-blackbox-exporter.service', 'priority': 3900, 'groups': ['etke', 'monitoring', 'prometheus', 'prometheus-node-exporters']}] if int_prometheus_blackbox_exporter_enabled else [])
    +
    ([{'name': 'int-scheduler.service', 'priority': 5000, 'groups': ['etke', 'scheduler']}] if int_scheduler_enabled else [])
    +
    ([{'name': 'int-scheduler-update.timer', 'priority': 5000, 'groups': ['etke', 'scheduler']}] if int_scheduler_enabled else [])
  }}

########################################################################
#                                                                      #
# /com.devture.ansible.role.systemd_service_manager                    #
#                                                                      #
########################################################################
