---
- name: Install ufw
  package:
    name: ufw
    state: present

- name: Ensure ufw stared and running
  service:
    state: started
    enabled: yes
    name: ufw

- name: Apply rules
  ufw:
    rule: "{{ item.rule }}"
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
    comment: "{{ item.name }}"
  with_items: "{{ system_security_ufw_rules }}"

- name: Allow email receiving
  ufw:
    rule: allow
    port: '25'
    proto: tcp
    comment: email2matrix
  when: matrix_email2matrix_enabled|bool

- name: Allow wireguard
  ufw:
    rule: allow
    port: "{{ custom_wireguard_port }}"
    proto: udp
    comment: wireguard server
  when: custom_wireguard_enabled|bool

- name: Allow wireguard network
  ufw:
    rule: allow
    interface: "{{ custom_wireguard_interface }}"
    direction: in
    proto: any
  when: custom_wireguard_enabled|bool

# TODO: remove after migration
- name: Remove ufw-docker
  file:
    path: /usr/local/bin/ufw-docker
    state: absent
  ignore_errors: yes

# TODO: remove after migration
- name: Remove ufw-docker patches
  replace:
    after: "# BEGIN UFW AND DOCKER"
    before: "# END UFW AND DOCKER"
    regexp: ".*"
    replace: ""
    path: /etc/ufw/after.rules
  ignore_errors: yes

# TODO: remove after migration
- name: Restart ufw service to load new rules
  service:
    name: ufw
    state: restarted

- name: Start ufw
  ufw:
    logging: 'on'
    policy: deny
    state: enabled
