---
- name: Install ufw
  package:
    name: ufw
    state: present

- name: Ensure ufw stared and running
  service:
    state: started
    enabled: yes
    name: ufw

- name: Apply rules
  ufw:
    rule: "{{ item.rule }}"
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
    comment: "{{ item.name }}"
  with_items: "{{ system_security_ufw_rules }}"

- name: Allow email receiving
  ufw:
    rule: allow
    port: '25'
    proto: tcp
    comment: email2matrix
  when: matrix_email2matrix_enabled|bool

- name: Allow wireguard
  ufw:
    rule: allow
    port: "{{ custom_wireguard_port }}"
    proto: udp
    comment: wireguard server
  when: custom_wireguard_enabled|bool

- name: Allow wireguard network
  ufw:
    rule: allow
    interface: "{{ custom_wireguard_interface }}"
    direction: in
    proto: any
  when: custom_wireguard_enabled|bool

- name: Install ufw-docker
  copy:
    src: "{{ role_path }}/files/ufw-docker"
    dest: /usr/local/bin/ufw-docker
    mode: 0775
    owner: "{{ matrix_user_username }}"
    group: "{{ matrix_user_groupname }}"

- name: Apply ufw-docker patches
  command: ufw-docker install

- name: "Allow {{ item }} external access"
  command: "ufw-docker allow {{ item }}"
  with_items: "{{ system_security_ufwdocker_allowed }}"
  ignore_errors: yes # not all containers may be available

- name: Restart ufw service to load new rules
  service:
    name: ufw
    state: restarted

- name: Start ufw
  ufw:
    logging: 'on'
    policy: deny
    state: enabled
